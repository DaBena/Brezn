# Publishes the APK from the latest GitHub release to Zapstore.
# Runs after every successful Build Android APK run
name: Publish to Zapstore
permissions:
  contents: read

on:
  workflow_run:
    workflows: ["Build Android APK"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Zapstore CLI
        run: |
          curl -sL https://cdn.zapstore.dev/6e2c7cf6da53c3f1a78b523a6aacd6316dce3d74ace6f859c2676729ee439990 -o zapstore
          echo '6e2c7cf6da53c3f1a78b523a6aacd6316dce3d74ace6f859c2676729ee439990  zapstore' | shasum -a 256 -c
          chmod +x zapstore
          ./zapstore --version || true

      - name: Publish to Zapstore
        env:
          SIGN_WITH: ${{ secrets.NOSTR_NSEC }}
        run: ./zapstore publish --no-overwrite-release --indexer-mode
        continue-on-error: true
